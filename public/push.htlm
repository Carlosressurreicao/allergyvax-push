<!DOCTYPE html><html lang="pt-br"><meta charset="utf-8"/>
<title>Enviar Push</title>
<body style="font-family:system-ui;padding:20px">
  <h1>Enviar Push</h1>
  <form id="f">
    <div>Título: <input id="t" value="Alerta AllergyVax"></div>
    <div>Mensagem: <input id="m" size="60" value="Olá, você está com vacina pendente. Favor comparecer ao posto de saúde."></div>
    <div>Plataformas:
      <label><input type="checkbox" name="p" value="ios" checked>iOS</label>
      <label><input type="checkbox" name="p" value="android" checked>Android</label>
      <label><input type="checkbox" name="p" value="pwa">PWA</label>
    </div>
    <div>Grupos (vírgula): <input id="g" placeholder="SCIT, SLIT"></div>
    <div>Deeplink URL: <input id="u" placeholder="https://allergyvax.goodbarber.app/consulta" size="60"></div>
    <p><button>Enviar</button></p>
  </form>
  <pre id="out" style="background:#111;color:#eee;padding:12px"></pre>

<script>
const $ = s=>document.querySelector(s);
function payload(){
  const title = $('#t').value.trim();
  const text  = $('#m').value.trim();
  const groups= $('#g').value.split(',').map(s=>s.trim()).filter(Boolean);
  const url   = $('#u').value.trim();
  const platform = [...document.querySelectorAll('input[name="p"]:checked')].map(i=>i.value);
  const p = { title, text, target:{ platform } };
  if(groups.length) p.target.groups = groups;
  if(url) p.deeplink = { type:"url", value:url };
  return p;
}
$('#f').addEventListener('submit', async e=>{
  e.preventDefault();
  $('#out').textContent = 'Enviando...';
  try{
    const res = await fetch('/api/push', {
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify({ payload: payload() })
    });
    let data; const ct = res.headers.get('content-type')||'';
    if(ct.includes('application/json')) data = await res.json();
    else data = { status: res.status, raw: await res.text() };
    $('#out').textContent = JSON.stringify(data, null, 2);
  }catch(err){
    $('#out').textContent = '❌ ' + err;
  }
});
</script>
</body></html>
